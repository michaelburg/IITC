<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      // Function to display the grid using an alert
      function displayGrid(sub_message, grid) {
        let message = "";
        for (let row of grid) {
          message += row.join(" | ") + "\n";
          message += "---------\n";
        }
        message += sub_message;
        return message;
      }
      // Example usage
      function get_index(input) {
        let row = parseInt(input / 3);
        if (input % 3 == 0) {
          row--;
        }
        let column;
        if (input % 3 == 0) {
          column = 2;
        } else {
          column = (input % 3) - 1;
        }
        return [row, column];
      }

      function is_input_in_range(input) {
        return input > 0 && input < 10;
      }

      function is_input_taken(grid, row, column) {
        return grid[row][column] == "X" || grid[row][column] == "O";
      }

      function check_win(grid, row, column, turn) {
        //check row
        for (let c = 0; c < 3; c++) {
          if (grid[row][c] != turn) break;
          return true;
        }
        //check column
        for (let r = 0; r < 3; r++) {
          if (grid[r][column] != turn) break;
          return true;
        }
        //check left to right
        let similar;
        if (row == column) {
          similar = true;
          for (let i = 0; i < 3; i++) {
            if (grid[i][i] != turn) {
              similar = false;
              break;
            }
          }
          if (similar) return true;
        }

        //check right ro left
        similar = true;
        let check_row = 0,
          check_column = 2;
        for (let i = 0; i < 3; i++) {
          if (grid[check_row][check_column] != turn) {
            similar = false;
            break;
          }
          check_row++;
          check_column--;
        }
        if (similar) return true;
        return false;
      }

      function get_user_input(grid) {
        while (true) {
          //get chosen sell from use
          input = parseInt(prompt(message));
          if (isNaN(input)) {
            //is input is number
            invalid_input_message = "invalid input";
            message = displayGrid(invalid_input_message, grid);
          } else if (!is_input_in_range(input)) {
            //is input in range(1-9)
            not_in_range_message = "input not in range";
            message = displayGrid(not_in_range_message, grid);
          } else {
            index = get_index(input); //convert input to cell
            taken_message = index;
            row = index[0];
            column = index[1];
            if (is_input_taken(grid, row, column)) {
              //is cell free
              taken_message = "cell already taken";
              message = displayGrid(taken_message, grid);
            } else {
              grid[row][column] = turn;
              break;
            }
          }
        }
      }

      function new_grid() {
        return [
          ["1", "2", "3"],
          ["4", "5", "6"],
          ["7", "8", "9"],
        ];
      }

      function get_player_name(player) {
        while (true) {
          player_input = prompt(`${player} player name: `);
          if (player_input != "") {
            return player_input;
          }
        }
      }

      function new_game() {
        const grid = new_grid();
        for (let i = 0; i < 9; i++) {
          if (i % 2 == 0) {
            turn = "X";
          } else {
            turn = "O";
          }
          new_turn_message = `it's ${turn} turn, good luck!`;
          message = displayGrid(new_turn_message, grid);
          get_user_input(grid);
          if (i > 3) {
            if (check_win(grid, row, column, turn)) {
              win_message = `${turn} has won`;
              message = displayGrid(win_message, grid);
              alert(message);
              return turn;
            }
          }
        }
        tie_message = "its a tie";
        message = displayGrid(tie_message, grid);
        alert(message);
        return "tie";
      }

      function stat_game() {
        let stat = {};
        while (true) {
          X_player = get_player_name("X");
          O_player = get_player_name("O");

          X_player_stat = JSON.parse(localStorage.getItem(X_player));
          if (X_player_stat == null) {
            X_player_stat = {
              win: 0,
              lose: 0,
              tie: 0,
            };
          }
          O_player_stat = JSON.parse(localStorage.getItem(O_player));
          if (O_player_stat == null) {
            O_player_stat = {
              win: 0,
              lose: 0,
              tie: 0,
            };
          }

          resault = new_game();
          if (resault == "X") {
            X_player_stat.win++;
            O_player_stat.lose++;
          } else if (resault == "O") {
            O_player_stat.win++;
            X_player_stat.lose++;
          } else {
            O_player_stat.tie++;
            X_player_stat.tie++;
          }
          localStorage.setItem(O_player, JSON.stringify(O_player_stat));
          localStorage.setItem(X_player, JSON.stringify(X_player_stat));

          stat = {};
          (keys = Object.keys(localStorage)), (i = keys.length);
          while (i--) {
            stat[keys[i]] = JSON.parse(localStorage.getItem(keys[i]));
          }

          let message = "";
          for (const player in stat) {
            message += player;
            message += ": ";
            for (const property in stat[player]) {
              message += property;
              message += ": ";
              message += stat[player][property];
              message += ", ";
            }
            message += "\n";
          }
          alert(message);
        }
      }
      stat_game();
    </script>
  </body>
</html>
